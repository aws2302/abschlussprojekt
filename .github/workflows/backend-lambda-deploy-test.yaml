name: Backend Lambda Deploy
run-name: Build and Deploy Lambda by ðŸš€ ${{ github.actor }} ðŸ¤–
on:
  push:
    branches:
      - dev-karim
    paths:
      - 'lambdas/**'
    # tags:
    #   - test-cicd-karim
env:
  AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN || 'default' }}
  AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY || 'default' }}
  AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY || 'default' }}
  AWS_ENDPOINT_URL_SSO: ${{ vars.AWS_ENDPOINT_URL_SSO || 'default' }}
  AWS_PROFILE: ${{ vars.AWS_PROFILE || 'techstarter' }}
  GITHUB_LAST_PUSH: ${{ vars.GITHUB_LAST_PUSH || github.event.before }}
jobs:
  Lambda-Code-Or-Function:
    runs-on: ubuntu-latest
    outputs:
      LAMBDA_TF: ${{ steps.python-script.outputs.LAMBDA_TF }}
    steps:
      - name: Lade neuen Repo-Zustand
        uses: actions/checkout@v4
      - name: erstelle ./pre-push-repo
        run: mkdir ./pre-push-repo
      - name: Lade letzten Repo-Zustand in ./pre-push-repo
        uses: actions/checkout@v4
        with:
          path: './pre-push-repo'
          ref: $GITHUB_LAST_PUSH
      - name: installiere NodeJs und npm
        uses: actions/setup-node@v4
        with:
          node-version: '>=18.0.0'
      - name: installiere Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 
      - name: PrÃ¼fe Bedingungen und erstelle ZIP's
        run: python .worklfows/scripts/handle_lambdas.py
      - name: Get Python-Script results
        id: python-script
        run: echo $LAMBDA_TF >> $GITHUB_OUTPUT
      - name: Lade artifacts hoch
        uses: actions/upload-artifact@v4
        with:
          name: Lambda-Zips
          path: "~/lambdas/artifacts"

  Lambda-Update-Code:
    if: ${{ LAMBDA_TF == "False" }}
    runs-on: ubuntu-latest
    needs: Lambda-Code-Or-Function
    env:
      LAMBDA_TF: ${{ needs.Lambda-Code-Or-Function.outputs.LAMBDA_TF }}
    outputs:
      ARTIFACT_DIR: ${{ steps.artifact-ls.outputs.ARTIFACT_DIR }}
    steps:
      - name: Get Lambda-Zips
        uses: actions/download-artifact@v4
        with:
          name: Lambda-Zips
          path: "~/lambdas/artifacts"
      - name: Echo LAMBDA_TF
        run: echo $LAMBDA_TF
      - name: Echo artifacts
        id: artifact-ls
        run: ls -la ~/lambdas/artifacts >> $GITHUB_OUTPUT